<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> bitcoinj(1) Getting started · Mi Tang</title><meta name="description" content="bitcoinj(1) Getting started - fish·nut"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://lpbobo.com/atom.xml" title="Mi Tang"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/categories/Science" target="_self" class="nav-list-link">SCIENCE</a></li><li class="nav-list-item"><a href="/categories/Trip" target="_self" class="nav-list-link">TRIP</a></li><li class="nav-list-item"><a href="/About" target="_self" class="nav-list-link">WE</a></li></ul></header><div class="wrap"><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">bitcoinj(1) Getting started</h1><div class="post-info">2016年5月12日</div><div class="post-content"><blockquote>
<p>bitcoinj是一个由java实现的比特币核心功能的开源库[<a href="https://github.com/bitcoinj/bitcoinj" target="_blank" rel="external">Github地址</a>]，项目主页为<a href="https://bitcoinj.github.io/" target="_blank" rel="external">https://bitcoinj.github.io/</a>。项目的核心开发者来自于Google，项目的文档十分丰富，非常适合Java开发者入手bitcoin的具体实现。</p>
</blockquote>
<a id="more"></a>
<p>注：本篇文章是笔者对bitcoinj研究过程的总结，内容主要来自项目主页、源代码以及个人理解，如果读者对bitcoin不熟悉的话，请先移步<a href="http://lpbobo.com/2016/04/29/%E8%81%8A%E8%81%8A%E5%8C%BA%E5%9D%97%E9%93%BE/">此处</a>，了解比特币的核心内容。</p>
<h3 id="编译bitcoinj"><a href="#编译bitcoinj" class="headerlink" title="编译bitcoinj"></a>编译bitcoinj</h3><ol>
<li>从<a href="https://github.com/bitcoinj/bitcoinj/branches" target="_blank" rel="external">Github</a>下载release版本的bitcoinj源码，最新(截至2016-05-12)版本为release-0.14；</li>
<li><p>bitcoinj工程是由maven管理的，可以通过maven命令进行编译，bitcoinj根目录下的pom.xml组织起多个子工程，在根目录下输入命令进行编译:</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean package</div></pre></td></tr></table></figure>
<p> 或者可以直接导入至IDE中，官方推荐IDEA，笔者使用eclipse，基本工程结构如下：</p>
<p> <img src="http://7xlu9w.com1.z0.glb.clouddn.com/mitang_science_bitcoinj_src.png" alt=""></p>
</li>
</ol>
<h3 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h3><p>bitcoinj提供的核心对象包括：</p>
<ul>
<li><strong>NetworkParameters</strong> from <em>org.bitcoinj.core</em></li>
<li><strong>Wallet</strong> from <em>org.bitcoinj.wallet</em></li>
<li><strong>PeerGroup</strong> from <em>org.bitcoinj.PeerGroup</em></li>
<li><strong>BlockStore</strong> from <em>org.bitcoinj.store</em></li>
<li><strong>BlockChain</strong> from <em>org.bitcoinj.core</em></li>
<li><strong>WalletEventListener</strong> from <em>org.bitcoinj.wallet.listeners</em></li>
<li><strong>WalletAppKit</strong>s from <em>org.bitcoinj.kits</em></li>
</ul>
<p>examples文件夹下的org/bitcoinj/examples/ForwardingService类展现了一个相对完整的使用示例，每当钱包收到bitcoin时，将会把它们发送到输入参数中的地址。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">BriefLogFormatter.init();</div><div class="line"><span class="keyword">if</span> (args.length &lt; <span class="number">1</span>) &#123;</div><div class="line">	System.err.println(<span class="string">"Usage: address-to-send-back-to [regtest|testnet]"</span>);</div><div class="line">	<span class="keyword">return</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">NetworkParameters params;</div><div class="line">String filePrefix;</div><div class="line"><span class="keyword">if</span> (args.length &gt; <span class="number">1</span> &amp;&amp; args[<span class="number">1</span>].equals(<span class="string">"testnet"</span>)) &#123;</div><div class="line">	params = TestNet3Params.get();</div><div class="line">	filePrefix = <span class="string">"forwarding-service-testnet"</span>;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (args.length &gt; <span class="number">1</span> &amp;&amp; args[<span class="number">1</span>].equals(<span class="string">"regtest"</span>)) &#123;</div><div class="line">	params = RegTestParams.get();</div><div class="line">	filePrefix = <span class="string">"forwarding-service-regtest"</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">	params = MainNetParams.get();</div><div class="line">	filePrefix = <span class="string">"forwarding-service"</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至少需要1个输入参数，第2个输入参数为网络连接类型，默认为主链，testnet与regtest分别代表公有的测试链和私有的测试链，其中regtest模式下区块生成速度非常快。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">forwardingAddress = Address.fromBase58(params, args[<span class="number">0</span>]);</div></pre></td></tr></table></figure>
<p>程序第1个参数应为一个接收方的钱包地址，经过Base58编码过的，形如“17kzeh4N8g49GFvdDzSf8PjaPfyoD1MndL”。forwardingAddress是一个<code>Address</code>类型的对象，表示目标地址。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kit = <span class="keyword">new</span> WalletAppKit(params, <span class="keyword">new</span> File(<span class="string">"."</span>), filePrefix);</div></pre></td></tr></table></figure>
<p>kit是一个<code>WalletAppKit</code>对象，相当于一个包装，其中自动引用了一些底层对象的操作，简化客户端的处理，具体可以参考WalletAppKit的实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">kit.startAsync();</div><div class="line">kit.awaitRunning();</div></pre></td></tr></table></figure>
<p>等待区块同步完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">kit.wallet().addCoinsReceivedEventListener(<span class="keyword">new</span> WalletCoinsReceivedEventListener() &#123;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCoinsReceived</span><span class="params">(Wallet w, Transaction tx, Coin prevBalance, Coin newBalance)</span> </span>&#123;</div><div class="line">  	</div><div class="line">  		Coin value = tx.getValueSentToMe(w);</div><div class="line">	    System.out.println(<span class="string">"Received tx for "</span> + value.toFriendlyString() + <span class="string">": "</span> + tx);</div><div class="line">    	System.out.println(<span class="string">"Transaction will be forwarded after it confirms."</span>);</div><div class="line">             </div><div class="line">    	Futures.addCallback(tx.getConfidence().getDepthFuture(<span class="number">1</span>), <span class="keyword">new</span> FutureCallback&lt;TransactionConfidence&gt;() &#123;</div><div class="line">        	<span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(TransactionConfidence result)</span> </span>&#123;</div><div class="line">            	forwardCoins(tx);</div><div class="line">            &#125;</div><div class="line">             </div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(Throwable t)</span> </span>&#123;</div><div class="line">            	<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(t);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;)；</div></pre></td></tr></table></figure>
<p>在钱包中新增一个入账的监听器，当钱包收到bitcoin时，将会触发<code>WalletCoinsReceivedEventListener</code>，打印出交易的基本信息。然后首先调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ListenableFuture&lt;Transaction&gt; future = tx.getConfidence().getDepthFuture(<span class="number">1</span>)</div></pre></td></tr></table></figure>
<p>我们知道区块链中一般至少经过6次确认才能确认一笔交易的真实性，目的是防止双花。Confidence对象表示客户对交易的信任程度，满足不同的阈值要求。ListenableFuture对象表示一个未来需要监听的事件，此处就是指getDepthFuture(1)，即当确认数为1时被触发，当然也可能被异常触发。在FutureCallback的回调函数中“确认”触发onSuccess，其中调用forwardCoins，异常则触发onFailure。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">forwardCoins</span><span class="params">(Transaction tx)</span> </span>&#123;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">    	Coin value = tx.getValueSentToMe(kit.wallet());</div><div class="line">        System.out.println(<span class="string">"Forwarding "</span> + value.toFriendlyString());</div><div class="line">            </div><div class="line">        <span class="keyword">final</span> Coin amountToSend = value.subtract(Transaction.REFERENCE_DEFAULT_MIN_TX_FEE);</div><div class="line">        <span class="keyword">final</span> Wallet.SendResult sendResult = kit.wallet().sendCoins(kit.peerGroup(), forwardingAddress, amountToSend);</div><div class="line">        checkNotNull(sendResult);  </div><div class="line">        System.out.println(<span class="string">"Sending ..."</span>);</div><div class="line">           </div><div class="line">       	sendResult.broadcastComplete.addListener(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        	<span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            	System.out.println(<span class="string">"Sent coins onwards! Transaction hash is "</span> + sendResult.tx.getHashAsString());</div><div class="line">            &#125;</div><div class="line">        &#125;, MoreExecutors.sameThreadExecutor());</div><div class="line">	&#125; <span class="keyword">catch</span> (KeyCrypterException | InsufficientMoneyException e) &#123;</div><div class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>发送bitcoin的过程就比较简单了，首先从交易中拿出我们收到的bitcoin，然后发送到指定的地址，监听发送结果。</p>
<p>总的来说，bitcoinj是由google得工程师写的，其中用到了很多google自己封装的数据类型，而且整体是一种事件编程的风格，用到很多listener，看起来有些复杂，用起来更复杂……搞完了入门，基本就可以开始看核心的API了。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/05/26/倒腾hexo/" class="prev">上一篇</a><a href="/2016/05/06/别学了，开始做吧/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://lpbobo.com">fish·nut</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p><p><span>友情链接</span>&#58;&nbsp;&nbsp;&nbsp;&nbsp;&bull;&nbsp;<a href="http://blog.csdn.net/sum__mer">sum__mer </a>&nbsp;&nbsp;&nbsp;&nbsp;&bull;&nbsp;<a href="http://www.rudy-yuan.net">rudy-yuan </a>&nbsp;&nbsp;&nbsp;&nbsp;&bull;&nbsp;<a href="http://elvin.im">花花世界 </a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>